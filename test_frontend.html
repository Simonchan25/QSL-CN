<!DOCTYPE html>
<html>
<head>
    <title>Test SSE</title>
</head>
<body>
    <h1>测试SSE接口</h1>
    <button onclick="testSSE()">测试流式接口</button>
    <button onclick="testDirect()">测试直接接口</button>
    <pre id="output"></pre>
    
    <script>
        function testSSE() {
            const output = document.getElementById('output');
            output.textContent = '开始测试SSE...\n';
            
            const url = 'http://localhost:8001/analyze/stream?name=贵州茅台&force=true';
            const es = new EventSource(url);
            let timeout;
            
            es.addEventListener('result', (ev) => {
                output.textContent += '收到结果事件: ' + ev.data.substring(0, 100) + '...\n';
                const data = JSON.parse(ev.data);
                if (data.text) {
                    output.textContent += '报告文本长度: ' + data.text.length + '\n';
                }
                es.close();
                clearTimeout(timeout);
            });
            
            es.addEventListener('error', (ev) => {
                output.textContent += '错误事件\n';
                es.close();
            });
            
            es.addEventListener('progress', (ev) => {
                output.textContent += '进度: ' + ev.data + '\n';
            });
            
            // 10秒超时
            timeout = setTimeout(() => {
                output.textContent += '超时，调用fallback\n';
                es.close();
                testDirect();
            }, 10000);
        }
        
        function testDirect() {
            const output = document.getElementById('output');
            output.textContent += '\n测试直接API...\n';
            
            fetch('http://localhost:8001/analyze/professional?name=贵州茅台&force=true')
                .then(r => r.json())
                .then(data => {
                    output.textContent += '成功获取数据\n';
                    output.textContent += 'text长度: ' + (data.text ? data.text.length : 0) + '\n';
                    output.textContent += '数据键: ' + Object.keys(data).join(', ') + '\n';
                })
                .catch(e => {
                    output.textContent += '错误: ' + e + '\n';
                });
        }
    </script>
</body>
</html>
